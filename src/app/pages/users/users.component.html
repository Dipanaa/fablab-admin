@if(notificationStatusService.statusMessage()){
  <div class="fixed mb-2 mr-2 right-0 bottom-0">
    <status-message></status-message>
  </div>
}

@if(openEditView()) {
  <modal-edit
    [fbEdit]="fbUser"
    (fbEditSend)="dataFormPut($event)"
    (closeModal)="openEditView.set($event)"
    [modalTitle]="'Editar usuario'"
    [loading]="loading()"
  ></modal-edit>
}


@if(openDeleteView()){
  <modal-component
    [show]="openDeleteView()"
    [title]="'¿Esta seguro que desea eliminar este usuario?'"
    [description]="
      'El usuario perdera acceso al sistema y no podra ser partícipe de las funciones del laboratorio.'
    "
    (close)="openDeleteView.set(false)"
    (decline)="openDeleteView.set(false)"
    (accept)="deleteUser()"
    [loading]="loading()"
  ></modal-component>
}

<div class="border-fablab-border flex flex-col gap-3">
  <div
    class="flex flex-col md:flex-row md:items-center md:justify-between gap-4"
  >
    <h1 class="text-3xl font-bold text-fablab-text-primary">
      Administración de Usuarios
    </h1>
    <div
      class="flex flex-col md:flex-row items-stretch md:items-center gap-3 w-full md:w-auto"
    >
      <searcher></searcher>
    </div>
  </div>
  <div
    class="h-auto w-full overflow-auto rounded-lg border border-fablab-border bg-fablab-card-bg"
  >
    <table class="min-w-full text-sm text-left text-fablab-text-secondary">
      <thead
        class="text-xs uppercase bg-fablab-text-secondary text-fablab-bg sticky top-0"
      >
        <tr>
          <th scope="col" class="px-4 py-3 font-bold">Nombre</th>
          <th scope="col" class="px-4 py-3 font-bold">Rut</th>
          <th scope="col" class="px-4 py-3 font-bold">Carrera</th>
          <th scope="col" class="px-4 py-3 font-bold">Rol</th>
          <th scope="col" class="px-4 py-3 font-bold">Proyectos</th>
          <th scope="col" class="px-4 py-3 font-bold">Acciones</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-fablab-border">
        @for (usuario of paginationService.pagedItems(); track
        usuario.id_usuario) {
        <tr class="hover:bg-fablab-border transition">
          <td class="px-4 py-4 whitespace-nowrap">
            <div class="flex items-center">
              @if (usuario.imgUrl) {
              <img
                class="h-10 w-10 rounded-full object-cover border border-fablab-text-secondary"
                [src]="usuario.imgUrl"
                [alt]="'Foto de perfil de ' + usuario.nombre"
              />
              } @else {
              <div
                class="rounded-full bg-fablab-border flex items-center justify-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="1.5"
                  stroke="currentColor"
                  class="size-12 text-fablab-text-secondary"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M17.982 18.725A7.488 7.488 0 0 0 12 15.75a7.488 7.488 0 0 0-5.982 2.975m11.963 0a9 9 0 1 0-11.963 0m11.963 0A8.966 8.966 0 0 1 12 21a8.966 8.966 0 0 1-5.982-2.275M15 9.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
                  />
                </svg>
              </div>
              }
              <div class="ml-3">
                <div class="font-medium text-fablab-text-primary">
                  {{ usuario.nombre }} {{ usuario.apellido }}
                </div>
                <div class="text-xs text-fablab-text-secondary">
                  {{ usuario.email || "sin_email@example.com" }}
                </div>
              </div>
            </div>
          </td>

          <td class="px-4 py-4 text-fablab-text-secondary">
            {{ usuario.rut }}
          </td>

          <td class="px-4 py-4 text-fablab-text-secondary">
            {{ usuario.carrera }}
          </td>

          <td class="px-4 py-4 text-fablab-text-secondary">
            {{ usuario.rol }}
          </td>

          <td class="px-4 py-4 text-fablab-text-secondary">
            <div class="max-h-10 overflow-y-auto">
              <ol class="list-decimal list-inside text-xs">
                @for (usuarios of usersService.usersData(); track $index) { @for
                (project of usuarios.proyectos_asignados; track $index) {
                <li>{{ project.titulo }}</li>
                } }
              </ol>
            </div>
          </td>
          <td class="px-4 py-4 text-fablab-text-secondary space-x-4">
            <button
              class="bg-fablab-accent text-black px-3 py-1 rounded hover:bg-fablab-accent-dark cursor-pointer"
              (click)="modalEditView(usuario.id_usuario)"
            >
              Editar
            </button>
            <button
              class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 cursor-pointer"
              (click)="modalDeleteView(usuario.id_usuario)"
            >
              Eliminar
            </button>
          </td>
        </tr>
        } @empty {
        <tr>
          <td
            colspan="6"
            class="text-center py-6 text-fablab-text-secondary bg-fablab-card-bg rounded-b-lg"
          >
            No se encontraron usuarios que coincidan con la búsqueda.
          </td>
        </tr>
        }
      </tbody>
    </table>
  </div>

  <pagination
    [currentPage]="paginationService.currentPage()"
    [totalPages]="paginationService.totalPages()"
    (pageChange)="paginationService.goToPage($event)"
  />
</div>
